{% extends "admin/base_admin.html" %}

{% block page_title %}Gerenciamento de Etiquetas{% endblock %}

{% block admin_content %}
<div class="admin-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3><i class="fas fa-tags"></i> Etiquetas de Frete</h3>
        <select id="filterStatus" class="btn-admin btn-admin-sm">
            <option value="">Todas</option>
            <option value="pendente">Pendentes</option>
            <option value="criada">Criadas</option>
            <option value="paga">Pagas</option>
            <option value="impressa">Impressas</option>
        </select>
    </div>
    
    <div id="etiquetas-container" class="loading">
        <div class="spinner"></div>
        <p>Carregando etiquetas...</p>
    </div>
</div>
{% endblock %}

{% block admin_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const container = document.getElementById('etiquetas-container');
    
    async function loadLabels(status = '') {
        try {
            const url = status ? `/api/admin/etiquetas/list?status=${status}` : '/api/admin/etiquetas/list';
            const response = await fetch(url, { credentials: 'include' });
            
            if (!response.ok) throw new Error('Erro ao carregar etiquetas');
            
            const data = await response.json();
            const labels = data.labels || [];
            
            if (labels.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Nenhuma etiqueta encontrada.</p>';
                return;
            }
            
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }
            
            function formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            }
            
            function getStatusBadge(status) {
                const badges = {
                    'pendente': '<span class="badge badge-warning">Pendente</span>',
                    'criada': '<span class="badge badge-info">Criada</span>',
                    'paga': '<span class="badge badge-success">Paga</span>',
                    'impressa': '<span class="badge badge-success">Impressa</span>',
                    'cancelada': '<span class="badge badge-danger">Cancelada</span>',
                    'erro': '<span class="badge badge-danger">Erro</span>'
                };
                return badges[status] || '<span class="badge">' + status + '</span>';
            }
            
            let tableHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Pedido</th>
                            <th>Protocolo</th>
                            <th>Transportadora</th>
                            <th>Status</th>
                            <th>Frete</th>
                            <th>Criada em</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            labels.forEach(label => {
                tableHTML += `
                    <tr>
                        <td><strong>${label.codigo_pedido}</strong></td>
                        <td>${label.melhor_envio_protocol || '-'}</td>
                        <td>${label.transportadora_nome || '-'}</td>
                        <td>${getStatusBadge(label.status_etiqueta)}</td>
                        <td>${formatCurrency(label.valor_frete || 0)}</td>
                        <td>${formatDate(label.criado_em)}</td>
                        <td>
                            ${label.status_etiqueta === 'criada' ? `<button onclick="checkoutLabel(${label.id})" class="btn-admin btn-admin-success btn-admin-sm">Pagar</button>` : ''}
                            ${label.status_etiqueta === 'paga' ? `<button onclick="printLabel(${label.id})" class="btn-admin btn-admin-primary btn-admin-sm">Imprimir</button>` : ''}
                            ${label.url_etiqueta ? `<a href="${label.url_etiqueta}" target="_blank" class="btn-admin btn-admin-primary btn-admin-sm">Ver</a>` : ''}
                            <button onclick="trackLabel(${label.id})" class="btn-admin btn-admin-sm">Rastrear</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
        } catch (error) {
            console.error('Erro ao carregar etiquetas:', error);
            container.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 5px;">Erro: ${error.message}</div>`;
        }
    }
    
    // Carregar inicial
    loadLabels();
    
    // Filtro
    document.getElementById('filterStatus').addEventListener('change', function(e) {
        loadLabels(e.target.value);
    });
    
    // Funções de ação
    window.checkoutLabel = async function(etiquetaId) {
        if (!confirm('Deseja pagar esta etiqueta no Melhor Envio?')) return;
        
        try {
            const response = await fetch(`/api/labels/checkout/${etiquetaId}`, {
                method: 'POST',
                credentials: 'include'
            });
            
            const data = await response.json();
            if (data.success) {
                alert('Etiqueta paga com sucesso!');
                loadLabels();
            } else {
                alert('Erro: ' + (data.erro || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro ao pagar etiqueta: ' + error.message);
        }
    };
    
    window.printLabel = async function(etiquetaId) {
        try {
            const response = await fetch(`/api/labels/print/${etiquetaId}`, {
                credentials: 'include'
            });
            
            const data = await response.json();
            if (data.success && data.url_etiqueta) {
                window.open(data.url_etiqueta, '_blank');
                loadLabels();
            } else {
                alert('Erro: ' + (data.erro || 'Erro desconhecido'));
            }
        } catch (error) {
            alert('Erro ao gerar impressão: ' + error.message);
        }
    };
    
    window.trackLabel = async function(etiquetaId) {
        try {
            const response = await fetch(`/api/labels/track/${etiquetaId}`, {
                credentials: 'include'
            });
            
            const data = await response.json();
            if (data.success && data.codigo_rastreamento) {
                const trackUrl = data.url_rastreamento || `https://www.correios.com.br/enviar/rastreamento?objeto=${data.codigo_rastreamento}`;
                window.open(trackUrl, '_blank');
            } else {
                alert('Erro: ' + (data.erro || 'Código de rastreamento não disponível'));
            }
        } catch (error) {
            alert('Erro ao rastrear: ' + error.message);
        }
    };
});
</script>
{% endblock %}

