{% extends "admin/base_admin.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block admin_content %}
<div id="dashboard-stats">
    <div class="loading">
        <div class="spinner"></div>
        <p>Carregando estatísticas...</p>
    </div>
</div>

<div id="dashboard-charts" style="display: none;">
    <!-- Estatísticas serão carregadas via JavaScript -->
</div>
{% endblock %}

{% block admin_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const statsContainer = document.getElementById('dashboard-stats');
    const chartsContainer = document.getElementById('dashboard-charts');
    
    try {
        const response = await fetch('/api/admin/dashboard/stats', {
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error('Erro ao carregar estatísticas');
        }
        
        const data = await response.json();
        const stats = data.stats;
        
        // Formatar valores monetários
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        // Renderizar cards de estatísticas
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <h4><i class="fas fa-shopping-cart"></i> Total de Vendas</h4>
                    <div class="value">${stats.total_vendas || 0}</div>
                </div>
                <div class="stat-card secondary">
                    <h4><i class="fas fa-dollar-sign"></i> Receita Total</h4>
                    <div class="value">${formatCurrency(stats.receita_total || 0)}</div>
                </div>
                <div class="stat-card success">
                    <h4><i class="fas fa-calendar-alt"></i> Vendas do Mês</h4>
                    <div class="value">${stats.vendas_mes || 0}</div>
                    <small style="opacity: 0.8;">${formatCurrency(stats.receita_mes || 0)}</small>
                </div>
                <div class="stat-card warning">
                    <h4><i class="fas fa-exclamation-triangle"></i> Pendências</h4>
                    <div class="value">${stats.pedidos_pendentes || 0}</div>
                    <small style="opacity: 0.8;">Pedidos pendentes</small>
                </div>
            </div>
            
            <div class="admin-card">
                <h3><i class="fas fa-box-open"></i> Produtos com Estoque Baixo</h3>
                <p style="font-size: 1.5em; color: #dc3545; font-weight: bold;">
                    ${stats.estoque_baixo || 0} produtos
                </p>
            </div>
            
            <div class="admin-card">
                <h3><i class="fas fa-tags"></i> Etiquetas Pendentes</h3>
                <p style="font-size: 1.5em; color: #ffc107; font-weight: bold;">
                    ${stats.etiquetas_pendentes || 0} etiquetas
                </p>
            </div>
        `;
        
        // Renderizar gráfico de vendas dos últimos 30 dias (se houver dados)
        if (stats.vendas_30_dias && stats.vendas_30_dias.length > 0) {
            chartsContainer.innerHTML = `
                <div class="admin-card">
                    <h3><i class="fas fa-chart-line"></i> Vendas dos Últimos 30 Dias</h3>
                    <canvas id="salesChart" style="max-height: 300px;"></canvas>
                </div>
            `;
            
            // Aqui você pode adicionar Chart.js ou outra biblioteca de gráficos
            // Por enquanto, vamos mostrar os dados em uma tabela
            const chartData = stats.vendas_30_dias;
            let tableHTML = '<table class="admin-table"><thead><tr><th>Data</th><th>Quantidade</th><th>Receita</th></tr></thead><tbody>';
            chartData.forEach(item => {
                tableHTML += `<tr><td>${new Date(item.dia).toLocaleDateString('pt-BR')}</td><td>${item.quantidade}</td><td>${formatCurrency(item.receita)}</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            
            chartsContainer.innerHTML = `
                <div class="admin-card">
                    <h3><i class="fas fa-chart-line"></i> Vendas dos Últimos 30 Dias</h3>
                    ${tableHTML}
                </div>
            `;
            chartsContainer.style.display = 'block';
        }
        
        // Top produtos
        if (stats.top_produtos && stats.top_produtos.length > 0) {
            let topProductsHTML = '<table class="admin-table"><thead><tr><th>Produto</th><th>Quantidade Vendida</th><th>Receita</th></tr></thead><tbody>';
            stats.top_produtos.forEach(product => {
                topProductsHTML += `<tr><td>${product.nome}</td><td>${product.quantidade}</td><td>${formatCurrency(product.receita)}</td></tr>`;
            });
            topProductsHTML += '</tbody></table>';
            
            chartsContainer.innerHTML += `
                <div class="admin-card">
                    <h3><i class="fas fa-star"></i> Top 5 Produtos Mais Vendidos</h3>
                    ${topProductsHTML}
                </div>
            `;
            chartsContainer.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        statsContainer.innerHTML = `
            <div class="admin-card" style="background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545;">
                <h3>Erro ao carregar estatísticas</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
});
</script>
{% endblock %}

