{% extends "admin/base_admin.html" %}

{% block page_title %}Gerenciamento de Estoque{% endblock %}

{% block admin_content %}
<div class="admin-card">
    <h3><i class="fas fa-boxes"></i> Produtos e Estoque</h3>
    
    <div id="estoque-container" class="loading">
        <div class="spinner"></div>
        <p>Carregando estoque...</p>
    </div>
</div>
{% endblock %}

{% block admin_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const container = document.getElementById('estoque-container');
    
    async function loadEstoque() {
        try {
            const response = await fetch('/api/admin/estoque/list', {
                credentials: 'include'
            });
            
            if (!response.ok) throw new Error('Erro ao carregar estoque');
            
            const data = await response.json();
            const produtos = data.produtos || [];
            
            if (produtos.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Nenhum produto encontrado.</p>';
                return;
            }
            
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }
            
            function getStatusBadge(status) {
                const badges = {
                    'zerado': '<span class="badge badge-danger">Zerado</span>',
                    'baixo': '<span class="badge badge-warning">Baixo</span>',
                    'medio': '<span class="badge badge-info">Médio</span>',
                    'alto': '<span class="badge badge-success">Alto</span>'
                };
                return badges[status] || '';
            }
            
            let tableHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Produto</th>
                            <th>Estampa / Tamanho</th>
                            <th>Estoque</th>
                            <th>Status</th>
                            <th>Preço Venda</th>
                            <th>Valor Estoque</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            produtos.forEach(produto => {
                tableHTML += `
                    <tr>
                        <td>${produto.codigo_sku || '-'}</td>
                        <td><strong>${produto.nome_produto}</strong></td>
                        <td>${produto.estampa} / ${produto.tamanho}</td>
                        <td><strong>${produto.estoque}</strong></td>
                        <td>${getStatusBadge(produto.status_estoque)}</td>
                        <td>${formatCurrency(produto.preco_venda || 0)}</td>
                        <td>${formatCurrency(produto.valor_estoque || 0)}</td>
                        <td>
                            <button onclick="editEstoque(${produto.id}, ${produto.estoque})" class="btn-admin btn-admin-primary btn-admin-sm">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
        } catch (error) {
            console.error('Erro ao carregar estoque:', error);
            container.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 5px;">Erro: ${error.message}</div>`;
        }
    }
    
    loadEstoque();
    
    window.editEstoque = function(produtoId, estoqueAtual) {
        const novaQuantidade = prompt(`Editar estoque do produto ID ${produtoId}\n\nEstoque atual: ${estoqueAtual}\n\nNova quantidade:`, estoqueAtual);
        
        if (novaQuantidade === null || novaQuantidade === '') return;
        
        const qtd = parseInt(novaQuantidade);
        if (isNaN(qtd) || qtd < 0) {
            alert('Quantidade inválida!');
            return;
        }
        
        // Atualizar via API
        fetch('/api/admin/estoque/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                produto_id: produtoId,
                quantidade: qtd
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Estoque atualizado com sucesso!');
                loadEstoque();
            } else {
                alert('Erro: ' + (data.erro || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            alert('Erro ao atualizar estoque: ' + error.message);
        });
    };
});
</script>
{% endblock %}

