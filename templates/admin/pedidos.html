{% extends "admin/base_admin.html" %}

{% block page_title %}Gerenciamento de Pedidos{% endblock %}

{% block admin_content %}
<div class="admin-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3><i class="fas fa-shopping-cart"></i> Pedidos</h3>
        <select id="filterStatus" class="btn-admin btn-admin-sm">
            <option value="">Todos</option>
            <option value="pendente_pagamento">Pendente Pagamento</option>
            <option value="processando_envio">Processando Envio</option>
            <option value="enviado">Enviado</option>
            <option value="entregue">Entregue</option>
            <option value="cancelado_pelo_cliente">Cancelado</option>
        </select>
    </div>
    
    <div id="pedidos-container" class="loading">
        <div class="spinner"></div>
        <p>Carregando pedidos...</p>
    </div>
</div>
{% endblock %}

{% block admin_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const container = document.getElementById('pedidos-container');
    
    async function loadPedidos(status = '') {
        try {
            const url = status ? `/api/admin/pedidos/list?status=${status}` : '/api/admin/pedidos/list';
            const response = await fetch(url, { credentials: 'include' });
            
            if (!response.ok) throw new Error('Erro ao carregar pedidos');
            
            const data = await response.json();
            const pedidos = data.pedidos || [];
            
            if (pedidos.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Nenhum pedido encontrado.</p>';
                return;
            }
            
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }
            
            function formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            }
            
            function getStatusBadge(status) {
                const badges = {
                    'pendente_pagamento': '<span class="badge badge-warning">Pendente Pagamento</span>',
                    'processando_envio': '<span class="badge badge-info">Processando</span>',
                    'enviado': '<span class="badge badge-success">Enviado</span>',
                    'entregue': '<span class="badge badge-success">Entregue</span>',
                    'cancelado_pelo_cliente': '<span class="badge badge-danger">Cancelado</span>',
                    'cancelado_pelo_vendedor': '<span class="badge badge-danger">Cancelado</span>'
                };
                return badges[status] || '<span class="badge">' + status + '</span>';
            }
            
            let tableHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Cliente</th>
                            <th>Data</th>
                            <th>Itens</th>
                            <th>Valor Total</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pedidos.forEach(pedido => {
                tableHTML += `
                    <tr>
                        <td><strong>${pedido.codigo_pedido}</strong></td>
                        <td>${pedido.nome_recebedor || 'N/A'}</td>
                        <td>${formatDate(pedido.data_venda)}</td>
                        <td>${pedido.total_itens || 0}</td>
                        <td><strong>${formatCurrency(pedido.valor_total || 0)}</strong></td>
                        <td>${getStatusBadge(pedido.status_pedido)}</td>
                        <td>
                            <a href="/order-status/${pedido.codigo_pedido}" target="_blank" class="btn-admin btn-admin-primary btn-admin-sm">
                                <i class="fas fa-eye"></i> Ver
                            </a>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            container.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 5px;">Erro: ${error.message}</div>`;
        }
    }
    
    // Carregar inicial
    loadPedidos();
    
    // Filtro
    document.getElementById('filterStatus').addEventListener('change', function(e) {
        loadPedidos(e.target.value);
    });
});
</script>
{% endblock %}

