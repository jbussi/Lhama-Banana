{% extends "admin/base_admin.html" %}

{% block page_title %}Análise de Vendas{% endblock %}

{% block admin_content %}
<div class="admin-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3><i class="fas fa-chart-bar"></i> Analytics de Vendas</h3>
        <select id="periodoSelect" class="btn-admin btn-admin-sm">
            <option value="7">Últimos 7 dias</option>
            <option value="30" selected>Últimos 30 dias</option>
            <option value="90">Últimos 90 dias</option>
            <option value="365">Último ano</option>
        </select>
    </div>
    
    <div id="analytics-container" class="loading">
        <div class="spinner"></div>
        <p>Carregando analytics...</p>
    </div>
</div>
{% endblock %}

{% block admin_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const container = document.getElementById('analytics-container');
    
    async function loadAnalytics(periodo = '30') {
        try {
            const response = await fetch(`/api/admin/vendas/analytics?periodo=${periodo}`, {
                credentials: 'include'
            });
            
            if (!response.ok) throw new Error('Erro ao carregar analytics');
            
            const data = await response.json();
            const analytics = data.analytics || {};
            
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }
            
            let html = '';
            
            // Vendas por dia
            if (analytics.vendas_por_dia && analytics.vendas_por_dia.length > 0) {
                html += `
                    <div class="admin-card" style="margin-bottom: 30px;">
                        <h3><i class="fas fa-calendar-day"></i> Vendas por Dia</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Quantidade</th>
                                    <th>Receita</th>
                                    <th>Ticket Médio</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                analytics.vendas_por_dia.forEach(item => {
                    html += `
                        <tr>
                            <td>${new Date(item.dia).toLocaleDateString('pt-BR')}</td>
                            <td>${item.quantidade}</td>
                            <td><strong>${formatCurrency(item.receita)}</strong></td>
                            <td>${formatCurrency(item.ticket_medio)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            // Vendas por status
            if (analytics.vendas_por_status && analytics.vendas_por_status.length > 0) {
                html += `
                    <div class="admin-card" style="margin-bottom: 30px;">
                        <h3><i class="fas fa-info-circle"></i> Vendas por Status</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Quantidade</th>
                                    <th>Receita</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                analytics.vendas_por_status.forEach(item => {
                    html += `
                        <tr>
                            <td><span class="badge badge-info">${item.status}</span></td>
                            <td>${item.quantidade}</td>
                            <td><strong>${formatCurrency(item.receita)}</strong></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            // Métodos de pagamento
            if (analytics.pagamentos && analytics.pagamentos.length > 0) {
                html += `
                    <div class="admin-card">
                        <h3><i class="fas fa-credit-card"></i> Métodos de Pagamento</h3>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Método</th>
                                    <th>Quantidade</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                analytics.pagamentos.forEach(item => {
                    html += `
                        <tr>
                            <td><strong>${item.metodo}</strong></td>
                            <td>${item.quantidade}</td>
                            <td><strong>${formatCurrency(item.total)}</strong></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            if (!html) {
                html = '<p style="text-align: center; padding: 40px; color: #999;">Nenhum dado disponível para o período selecionado.</p>';
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Erro ao carregar analytics:', error);
            container.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 5px;">Erro: ${error.message}</div>`;
        }
    }
    
    // Carregar inicial
    loadAnalytics();
    
    // Filtro de período
    document.getElementById('periodoSelect').addEventListener('change', function(e) {
        container.innerHTML = '<div class="spinner"></div><p>Carregando...</p>';
        loadAnalytics(e.target.value);
    });
});
</script>
{% endblock %}

