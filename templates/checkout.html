{% extends "base.html" %}

{% block title %}Checkout - LhamaBanana{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/checkout.css') }}">
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="checkout-header animate-fadeInUp">
        <h1>üõí Finalizar Compra</h1>
        <p>Quase l√°! Complete seus dados para finalizar o pedido</p>
    </div>

    <div class="checkout-content">
        <!-- Formul√°rio de Checkout -->
        <div class="checkout-form-section">
            <form id="checkoutForm" class="checkout-form">
                <!-- Informa√ß√µes de Entrega -->
                <div class="form-section card animate-fadeInUp">
                    <div class="section-header">
                        <h2>üìç Endere√ßo de Entrega</h2>
                        <div class="section-icon">üöö</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_recebedor">Nome Completo *</label>
                            <input type="text" id="nome_recebedor" name="nome_recebedor" required>
                        </div>
                        <div class="form-group">
                            <label for="cep">CEP *</label>
                            <input type="text" id="cep" name="cep" placeholder="00000-000" required>
                            <button type="button" id="buscarCep" class="btn-outline btn-small">üîç Buscar</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="rua">Rua *</label>
                            <input type="text" id="rua" name="rua" required>
                        </div>
                        <div class="form-group">
                            <label for="numero">N√∫mero *</label>
                            <input type="text" id="numero" name="numero" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="complemento">Complemento</label>
                            <input type="text" id="complemento" name="complemento">
                        </div>
                        <div class="form-group">
                            <label for="bairro">Bairro *</label>
                            <input type="text" id="bairro" name="bairro" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cidade">Cidade *</label>
                            <input type="text" id="cidade" name="cidade" required>
                        </div>
                        <div class="form-group">
                            <label for="estado">Estado *</label>
                            <select id="estado" name="estado" required>
                                <option value="">Selecione</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amap√°</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MA">Maranh√£o</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Par√°</option>
                                <option value="PB">Para√≠ba</option>
                                <option value="PR">Paran√°</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piau√≠</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rond√¥nia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Op√ß√µes de Frete -->
                <div class="form-section card animate-fadeInUp">
                    <div class="section-header">
                        <h2>üöö Op√ß√µes de Frete</h2>
                        <div class="section-icon">üì¶</div>
                    </div>
                    
                    <div id="shippingOptions" class="shipping-options">
                        <div class="shipping-loading">
                            <div class="loading-spinner animate-spin"></div>
                            <p>Calculando frete...</p>
                        </div>
                    </div>
                </div>

                <!-- M√©todo de Pagamento -->
                <div class="form-section card animate-fadeInUp">
                    <div class="section-header">
                        <h2>üí≥ M√©todo de Pagamento</h2>
                        <div class="section-icon">üí∏</div>
                    </div>
                    
                    <div class="payment-methods">
                        <div class="payment-option">
                            <input type="radio" id="pix" name="payment_method" value="PIX" checked>
                            <label for="pix" class="payment-label">
                                <div class="payment-icon">üì±</div>
                                <div class="payment-info">
                                    <span class="payment-name">PIX</span>
                                    <span class="payment-desc">Aprova√ß√£o instant√¢nea</span>
                                </div>
                            </label>
                        </div>

                        <div class="payment-option">
                            <input type="radio" id="credit_card" name="payment_method" value="CREDIT_CARD">
                            <label for="credit_card" class="payment-label">
                                <div class="payment-icon">üí≥</div>
                                <div class="payment-info">
                                    <span class="payment-name">Cart√£o de Cr√©dito</span>
                                    <span class="payment-desc">Visa, Mastercard, Elo</span>
                                </div>
                            </label>
                        </div>

                        <div class="payment-option">
                            <input type="radio" id="boleto" name="payment_method" value="BOLETO">
                            <label for="boleto" class="payment-label">
                                <div class="payment-icon">üìÑ</div>
                                <div class="payment-info">
                                    <span class="payment-name">Boleto Banc√°rio</span>
                                    <span class="payment-desc">Aprova√ß√£o em at√© 3 dias</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Formul√°rio do Cart√£o (oculto por padr√£o) -->
                    <div id="creditCardForm" class="credit-card-form" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card_number">N√∫mero do Cart√£o *</label>
                                <input type="text" id="card_number" name="card_number" placeholder="0000 0000 0000 0000">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card_holder_name">Nome no Cart√£o *</label>
                                <input type="text" id="card_holder_name" name="card_holder_name" placeholder="JO√ÉO SILVA">
                            </div>
                            <div class="form-group">
                                <label for="card_exp_month">Validade *</label>
                                <div class="expiry-inputs">
                                    <input type="text" id="card_exp_month" name="card_exp_month" placeholder="MM" maxlength="2">
                                    <span>/</span>
                                    <input type="text" id="card_exp_year" name="card_exp_year" placeholder="AA" maxlength="2">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="card_cvv">CVV *</label>
                                <input type="text" id="card_cvv" name="card_cvv" placeholder="000" maxlength="3">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="installments">Parcelas</label>
                                <select id="installments" name="installments">
                                    <option value="1">1x sem juros</option>
                                    <option value="2">2x sem juros</option>
                                    <option value="3">3x sem juros</option>
                                    <option value="4">4x sem juros</option>
                                    <option value="5">5x sem juros</option>
                                    <option value="6">6x sem juros</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√£o de Finalizar -->
                <div class="checkout-actions">
                    <button type="submit" id="finalizarCompra" class="btn-primary btn-large btn-icon">
                        <span>üõí</span>
                        <span>Finalizar Compra</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Resumo do Pedido -->
        <div class="checkout-summary">
            <div class="summary-card card animate-slideInRight">
                <div class="summary-header">
                    <h3>üìã Resumo do Pedido</h3>
                </div>
                
                <div id="cartItems" class="summary-items">
                    <!-- Itens ser√£o carregados via JavaScript -->
                </div>
                
                <div class="summary-totals">
                    <div class="total-line">
                        <span>Subtotal:</span>
                        <span id="subtotal">R$ 0,00</span>
                    </div>
                    <div class="total-line">
                        <span>Frete:</span>
                        <span id="freight">R$ 0,00</span>
                    </div>
                    <div class="total-line total-final">
                        <span>Total:</span>
                        <span id="total">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="checkoutLoading" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner animate-spin"></div>
        <h3>Processando seu pedido...</h3>
        <p>Por favor, aguarde um momento</p>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Checkout] Script de checkout carregado');
    
    // --- Elementos do resumo do pedido ---
    const cartItemsContainer = document.getElementById('cartItems');
    const subtotalElem = document.getElementById('subtotal');
    const freightElem = document.getElementById('freight');
    const totalElem = document.getElementById('total');
    
    // --- Elementos do formul√°rio de endere√ßo ---
    const cepInput = document.getElementById('cep');
    const buscarCepBtn = document.getElementById('buscarCep');
    const ruaInput = document.getElementById('rua');
    const bairroInput = document.getElementById('bairro');
    const cidadeInput = document.getElementById('cidade');
    const estadoSelect = document.getElementById('estado');
    const numeroInput = document.getElementById('numero');
    
    // --- Vari√°veis globais para dados do carrinho ---
    let cartData = {
        items: [],
        total_value: 0,
        freight: 0
    };
    
    /**
     * Formata valor monet√°rio em R$
     */
    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }
    
    /**
     * Obt√©m headers de autentica√ß√£o com session ID
     */
    async function getAuthHeaders() {
        const headers = {
            'Content-Type': 'application/json'
        };

        // Busca o session ID do localStorage (mesmo usado no carrinho)
        let sessionId = localStorage.getItem('cartSessionId');
        // Se n√£o houver session ID no localStorage, gerar um novo UUID
        if (!sessionId) {
            sessionId = crypto.randomUUID();
            localStorage.setItem('cartSessionId', sessionId);
        }
        headers['X-Session-ID'] = sessionId;
        
        return headers;
    }
    
    /**
     * Busca os dados do carrinho na API
     */
    async function fetchCartData() {
        try {
            console.log('[Checkout] Buscando dados do carrinho...');
            
            const headers = await getAuthHeaders();
            console.log('[Checkout] Headers de autentica√ß√£o:', {
                hasSessionId: !!headers['X-Session-ID'],
                sessionId: headers['X-Session-ID']?.substring(0, 8) + '...'
            });
            
            const response = await fetch('/api/cart', {
                method: 'GET',
                credentials: 'include',
                headers: headers
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ erro: 'Erro desconhecido' }));
                console.error('[Checkout] Erro ao buscar carrinho:', errorData);
                
                if (response.status === 401) {
                    console.warn('[Checkout] Usu√°rio n√£o autenticado, carrinho pode estar vazio.');
                    return { items: [], total_value: 0 };
                }
                
                throw new Error(errorData.erro || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('[Checkout] Dados do carrinho recebidos:', {
                itemsCount: data.items?.length || 0,
                totalValue: data.total_value
            });
            
            return {
                items: data.items || [],
                total_value: data.total_value || 0
            };
            
        } catch (error) {
            console.error('[Checkout] Erro ao buscar dados do carrinho:', {
                message: error.message,
                stack: error.stack
            });
            
            return { items: [], total_value: 0 };
        }
    }
    
    /**
     * Renderiza os itens do carrinho no resumo
     */
    function renderCartItems() {
        if (!cartItemsContainer) {
            console.warn('[Checkout] Container de itens do carrinho n√£o encontrado');
            return;
        }
        
        cartItemsContainer.innerHTML = '';
        
        if (!cartData.items || cartData.items.length === 0) {
            cartItemsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #666;">
                    <p>Seu carrinho est√° vazio</p>
                    <a href="/produtos" style="color: #007bff; text-decoration: none;">‚Üê Continuar comprando</a>
                </div>
            `;
            return;
        }
        
        cartData.items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'summary-item';
            itemDiv.style.cssText = 'display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee;';
            
            const itemImage = item.image_url || '/static/img/placeholder.jpg';
            const itemPrice = item.price_at_time_of_add || 0;
            const itemTotal = item.item_total || (item.quantity * itemPrice);
            
            itemDiv.innerHTML = `
                <img src="${itemImage}" alt="${item.product_name}" 
                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 15px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 5px;">${item.product_name}</div>
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 3px;">
                        ${item.estampa_name} / ${item.tamanho_name}
                    </div>
                    <div style="font-size: 0.85em; color: #999;">
                        Qtd: ${item.quantity} √ó ${formatCurrency(itemPrice)}
                    </div>
                </div>
                <div style="font-weight: 600; color: #333;">
                    ${formatCurrency(itemTotal)}
                </div>
            `;
            
            cartItemsContainer.appendChild(itemDiv);
        });
    }
    
    /**
     * Atualiza os totais do pedido
     */
    function updateTotals() {
        const subtotal = cartData.total_value || 0;
        const freight = cartData.freight || 0;
        const total = subtotal + freight;
        
        if (subtotalElem) subtotalElem.textContent = formatCurrency(subtotal);
        if (freightElem) freightElem.textContent = formatCurrency(freight);
        if (totalElem) totalElem.textContent = formatCurrency(total);
        
        console.log('[Checkout] Totais atualizados:', {
            subtotal: subtotal,
            freight: freight,
            total: total
        });
    }
    
    /**
     * Carrega e renderiza os dados do carrinho
     */
    async function loadCartData() {
        try {
            cartData = await fetchCartData();
            renderCartItems();
            updateTotals();
        } catch (error) {
            console.error('[Checkout] Erro ao carregar dados do carrinho:', error);
            
            if (cartItemsContainer) {
                cartItemsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc3545;">
                        <p>Erro ao carregar carrinho</p>
                        <button onclick="window.location.reload()" 
                                style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Recarregar
                        </button>
                    </div>
                `;
            }
        }
    }
    
    // Carregar dados do carrinho ao inicializar
    loadCartData();
    
    /**
     * Busca endere√ßo na ViaCEP API
     */
    async function fetchAddressByCEP(cep) {
        try {
            // Remove caracteres n√£o num√©ricos
            const cleanCEP = cep.replace(/\D/g, '');
            
            // Valida√ß√£o do CEP
            if (cleanCEP.length !== 8) {
                console.warn('[Checkout] CEP inv√°lido:', cep);
                return null;
            }
            
            console.log('[Checkout] Buscando endere√ßo na ViaCEP para CEP:', cleanCEP);
            
            const response = await fetch(`https://viacep.com.br/ws/${cleanCEP}/json/`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // ViaCEP retorna {erro: true} quando o CEP n√£o √© encontrado
            if (data.erro) {
                console.warn('[Checkout] CEP n√£o encontrado na ViaCEP:', cleanCEP);
                alert('CEP n√£o encontrado. Verifique o CEP digitado.');
                return null;
            }
            
            console.log('[Checkout] Endere√ßo encontrado:', data);
            
            return {
                street: data.logradouro || '',
                district: data.bairro || '',
                city: data.localidade || '',
                state: data.uf || '',
                cep: data.cep || cleanCEP
            };
            
        } catch (error) {
            console.error('[Checkout] Erro ao buscar CEP na ViaCEP:', {
                message: error.message,
                cep: cep
            });
            alert('Erro ao buscar CEP. Verifique sua conex√£o e tente novamente.');
            return null;
        }
    }
    
    /**
     * Preenche automaticamente os campos de endere√ßo
     */
    async function fillAddressByCEP(cep) {
        if (!cep || cep.replace(/\D/g, '').length !== 8) {
            return;
        }
        
        // Mostra feedback visual
        const originalPlaceholder = cepInput.placeholder;
        const originalValue = cepInput.value;
        cepInput.disabled = true;
        cepInput.placeholder = 'Buscando endere√ßo...';
        
        if (buscarCepBtn) {
            buscarCepBtn.disabled = true;
            buscarCepBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        
        try {
            const addressData = await fetchAddressByCEP(cep);
            
            if (addressData) {
                // Preenche os campos
                if (ruaInput) ruaInput.value = addressData.street;
                if (bairroInput) bairroInput.value = addressData.district;
                if (cidadeInput) cidadeInput.value = addressData.city;
                
                // Preenche o estado no select
                if (estadoSelect && addressData.state) {
                    estadoSelect.value = addressData.state;
                }
                
                // Formata e atualiza o CEP
                const formattedCEP = addressData.cep.replace(/^(\d{5})(\d{3})$/, '$1-$2');
                cepInput.value = formattedCEP;
                
                console.log('[Checkout] Campos preenchidos automaticamente');
                
                // Foca no campo de n√∫mero
                if (numeroInput) {
                    setTimeout(() => numeroInput.focus(), 100);
                }
                
                // Buscar op√ß√µes de frete ap√≥s preencher o endere√ßo
                if (cep.replace(/\D/g, '').length === 8) {
                    setTimeout(() => calculateShipping(cep), 500);
                }
            }
        } catch (error) {
            console.error('[Checkout] Erro ao preencher endere√ßo:', error);
        } finally {
            // Restaura estado dos campos
            cepInput.disabled = false;
            cepInput.placeholder = originalPlaceholder;
            
            if (buscarCepBtn) {
                buscarCepBtn.disabled = false;
                buscarCepBtn.innerHTML = 'üîç Buscar';
            }
        }
    }
    
    /**
     * Busca e exibe op√ß√µes de frete
     */
    window.calculateShipping = async function(cep) {
        const shippingOptionsContainer = document.getElementById('shippingOptions');
        if (!shippingOptionsContainer) {
            console.warn('[Checkout] Container de op√ß√µes de frete n√£o encontrado');
            return;
        }
        
        // Limpar CEP
        const cleanCEP = cep.replace(/\D/g, '');
        if (cleanCEP.length !== 8) {
            return;
        }
        
        // Mostrar loading
        shippingOptionsContainer.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div class="loading-spinner animate-spin" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; margin: 0 auto 10px;"></div>
                <p>Calculando frete...</p>
            </div>
        `;
        
        try {
            const headers = await getAuthHeaders();
            console.log('[Checkout] Calculando frete para CEP:', cleanCEP);
            
            const response = await fetch('/api/shipping/calculate', {
                method: 'POST',
                credentials: 'include',
                headers: headers,
                body: JSON.stringify({ cep: cleanCEP })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ erro: 'Erro desconhecido' }));
                throw new Error(errorData.erro || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('[Checkout] Op√ß√µes de frete recebidas:', data);
            
            if (!data.shipping_options || data.shipping_options.length === 0) {
                shippingOptionsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>N√£o foi poss√≠vel calcular o frete para este CEP.</p>
                        <p style="font-size: 0.9em; color: #999;">Verifique o CEP e tente novamente.</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar op√ß√µes de frete
            renderShippingOptions(data.shipping_options);
            
        } catch (error) {
            console.error('[Checkout] Erro ao calcular frete:', {
                message: error.message,
                stack: error.stack
            });
            
            shippingOptionsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #dc3545;">
                    <p>Erro ao calcular frete</p>
                    <p style="font-size: 0.9em; color: #999;">${error.message}</p>
                    <button onclick="calculateShipping('${cleanCEP}')" 
                            style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Tentar novamente
                    </button>
                </div>
            `;
        }
    }
    
    /**
     * Renderiza as op√ß√µes de frete
     */
    function renderShippingOptions(options) {
        const shippingOptionsContainer = document.getElementById('shippingOptions');
        if (!shippingOptionsContainer) return;
        
        shippingOptionsContainer.innerHTML = '';
        
        // Vari√°vel para armazenar a op√ß√£o selecionada
        let selectedShippingOption = null;
        
        options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'shipping-option';
            optionDiv.style.cssText = `
                display: flex;
                align-items: center;
                padding: 15px;
                margin-bottom: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s;
            `;
            
            const priceFormatted = formatCurrency(option.price);
            
            optionDiv.innerHTML = `
                <input type="radio" name="shipping-option" id="shipping-${index}" 
                       value="${option.service}" style="margin-right: 15px; cursor: pointer;">
                <label for="shipping-${index}" style="flex: 1; cursor: pointer;">
                    <div style="font-weight: 600; margin-bottom: 5px;">${option.name}</div>
                    <div style="font-size: 0.9em; color: #666;">${option.description || option.delivery_time}</div>
                    <div style="font-size: 0.85em; color: #999; margin-top: 3px;">${option.delivery_time}</div>
                </label>
                <div style="font-weight: 700; font-size: 1.2em; color: #007bff;">
                    ${priceFormatted}
                </div>
            `;
            
            // Event listener para sele√ß√£o
            optionDiv.addEventListener('click', function() {
                // Remove sele√ß√£o anterior
                document.querySelectorAll('input[name="shipping-option"]').forEach(radio => {
                    radio.checked = false;
                    radio.closest('.shipping-option').style.borderColor = '#e0e0e0';
                    radio.closest('.shipping-option').style.backgroundColor = '';
                });
                
                // Seleciona esta op√ß√£o
                const radio = optionDiv.querySelector('input[type="radio"]');
                radio.checked = true;
                optionDiv.style.borderColor = '#007bff';
                optionDiv.style.backgroundColor = '#f0f8ff';
                
                // Atualiza totais
                selectedShippingOption = option;
                cartData.freight = option.price;
                updateTotals();
                
                console.log('[Checkout] Frete selecionado:', option);
            });
            
            // Selecionar primeira op√ß√£o automaticamente
            if (index === 0) {
                setTimeout(() => optionDiv.click(), 100);
            }
            
            shippingOptionsContainer.appendChild(optionDiv);
        });
    }
    
    // Event listener no bot√£o de buscar CEP
    if (buscarCepBtn && cepInput) {
        buscarCepBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length === 8) {
                fillAddressByCEP(cep);
            } else {
                alert('Por favor, digite um CEP v√°lido (8 d√≠gitos)');
                cepInput.focus();
            }
        });
    }
    
    // Formata√ß√£o autom√°tica do CEP enquanto digita (00000-000)
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            
            e.target.value = value;
        });
        
        // Busca autom√°tica quando completa 8 d√≠gitos (ap√≥s 800ms)
        let cepTimeout;
        cepInput.addEventListener('input', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            
            clearTimeout(cepTimeout);
            
            if (value.length === 8) {
                cepTimeout = setTimeout(() => {
                    fillAddressByCEP(value);
                }, 800);
            }
        });
        
        // Busca quando o campo perde o foco e tem 8 d√≠gitos
        cepInput.addEventListener('blur', function(e) {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length === 8) {
                fillAddressByCEP(cep);
            }
        });
    }
});
</script>
{% endblock %}

